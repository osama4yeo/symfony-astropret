{# --- FICHIER TWIG PRINCIPAL --- #}
{# Ce fichier h√©rite d'une structure de base 'base.html.twig'. C'est une bonne pratique dans Symfony. #}
{% extends 'base.html.twig' %}

{# D√©finit le titre de la page qui appara√Ætra dans l'onglet du navigateur. #}
{% block title %}Calendrier des √©v√©nements{% endblock %}

{# --- CONTENU PRINCIPAL DE LA PAGE --- #}
{% block body_content %}
    {# 'container' et 'mt-4' sont des classes Bootstrap pour centrer le contenu et ajouter une marge au-dessus. #}
    <div class="container mt-4">
        <h2>Calendrier des √©v√©nements</h2>

        {# --- SECTION R√âSERV√âE AUX ADMINISTRATEURS --- #}
        {# üîê C'est une v√©rification de s√©curit√©. Le contenu de ce 'if' ne s'affichera que si l'utilisateur connect√© a le r√¥le 'ROLE_ADMIN'. #}
        {# 'is_granted' est une fonction de s√©curit√© de Symfony, c'est la bonne mani√®re de faire. #}
        {% if is_granted('ROLE_ADMIN') %}
            {# 'text-end' et 'mb-3' sont des classes Bootstrap pour aligner √† droite et ajouter une marge en dessous. #}
            <div class="text-end mb-3">
                {# Le lien pointe vers une route Symfony nomm√©e 'calendar_manage'. Utiliser path() est une bonne pratique car si vous changez l'URL dans vos routes, le lien se mettra √† jour automatiquement. #}
                <a href="{{ path('calendar_manage') }}" class="btn btn-primary">
                    Gestion des √©v√©nements
                </a>
            </div>
        {% endif %}

        {# --- CONTENEUR DU CALENDRIER --- #}
        {# C'est dans cette balise 'div' que la biblioth√®que JavaScript FullCalendar va g√©n√©rer et afficher le calendrier. L'ID 'calendar' est essentiel pour que le script JS puisse la trouver. #}
        <div id="calendar"></div>
    </div>
{% endblock %}

{# --- FEUILLES DE STYLE (CSS) SP√âCIFIQUES √Ä CETTE PAGE --- #}
{% block stylesheets %}
    {# 'parent()' inclut les feuilles de style du fichier de base 'base.html.twig'. Tr√®s important pour ne pas perdre le style global du site. #}
    {{ parent() }}
    
    {# Lien vers le fichier CSS de FullCalendar via un CDN (Content Delivery Network). C'est rapide et efficace. #}
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
    
    {# Styles CSS personnalis√©s pour cette page. #}
    <style>
        /* --- STYLES G√âN√âRAUX --- */
        body {
            background-color: #f8f9fa; /* Couleur de fond de la page. */
        }

        h2 {
            font-weight: 600; /* Titre en gras. */
            color: #343a40; /* Couleur de texte sombre. */
            text-align: center; /* Titre centr√©. */
            margin-bottom: 30px; /* Espace sous le titre. */
        }
        
        /* --- STYLE DU CONTENEUR DU CALENDRIER --- */
        #calendar {
            max-width: 100%;
            width: 100%;
            min-height: 700px; /* Hauteur minimale pour √©viter qu'il soit trop petit. */
            background-color: #ffffff; /* Fond blanc pour le calendrier. */
            border-radius: 12px; /* Bords arrondis. */
            padding: 20px; /* Espace int√©rieur. */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* Ombre l√©g√®re pour un effet de profondeur. */
            overflow-x: auto; /* Ajoute une barre de d√©filement horizontale si n√©cessaire sur petits √©crans. */
        }

        /* --- STYLES DES √âV√âNEMENTS DANS LE CALENDRIER --- */
        /* Cible les bo√Ætes d'√©v√©nements dans la vue mensuelle. */
        .fc-daygrid-event {
            background-color: #0b5ed7 !important; /* Couleur de fond bleue. '!important' force ce style √† s'appliquer. */
            color: white !important; /* Texte en blanc. */
            border: none !important; /* Aucune bordure. */
            border-radius: 6px; /* Bords arrondis. */
            padding: 2px 6px;
            font-size: 0.8rem; /* Taille de police l√©g√®rement r√©duite. */
            font-weight: 500;
            white-space: normal !important; /* Permet au texte d'aller √† la ligne. */
            overflow-wrap: break-word; /* Coupe les mots longs pour √©viter qu'ils ne d√©bordent. */
        }

        /* Assure que le texte √† l'int√©rieur de l'√©v√©nement (heure et titre) peut aller √† la ligne. */
        .fc-event-time, .fc-event-title {
            white-space: normal !important;
            word-break: break-word !important;
            text-align: left; /* Aligne le texte √† gauche dans l'√©v√©nement. */
        }

        /* Assure que l'√©v√©nement prend toute la largeur de sa case. */
        .fc-daygrid-event {
            display: block !important;
            width: 100% !important;
            line-height: 1.1; /* Hauteur de ligne pour un espacement correct. */
            padding: 4px 6px;
        }

        /* Assure que le texte reste blanc m√™me s'il est dans un lien. */
        .fc-daygrid-event .fc-event-title,
        .fc-daygrid-event .fc-event-time {
            color: white !important;
        }

        /* --- STYLES DE LA BARRE D'OUTILS DE FULLCALENDAR --- */
        /* Style du titre du calendrier (ex: Juin 2024) */
        .fc-toolbar-title {
            font-size: 1.4rem;
            font-weight: 500;
            color: #343a40;
            text-transform: capitalize; /* Met la premi√®re lettre de chaque mot en majuscule (ex: "Juin 2024"). */
        }

        /* Styles des boutons (Pr√©c√©dent, Suivant, Mois, etc.) */
        .fc-button {
            background-color: #0d6efd !important;
            border: none !important;
            border-radius: 6px !important;
            font-size: 0.9rem; 
        }

        /* Style des boutons au survol de la souris. */
        .fc-button-primary:not(:disabled):hover {
            background-color: #0b5ed7 !important;
        }

        /* Ajoute un petit espace entre les boutons dans un groupe (ex: entre 'prev' et 'next'). */
        .fc .fc-button-group > .fc-button {
            margin-right: 6px;
        }

        /* --- STYLES DES CELLULES DU CALENDRIER --- */
        /* Style des en-t√™tes de jours (Lundi, Mardi, ...) */
        .fc-col-header-cell-cushion { 
            color: black !important; /* Texte en noir. */
            text-decoration: none !important; /* Enl√®ve le soulignement s'il y en a un. */
        }

        /* Styles pour les num√©ros de jour pour qu'ils soient noirs et non soulign√©s. */
        .fc-daygrid-day-number, /* Vue mois */
        .fc-timegrid-axis-cushion, /* Axe des heures (vue semaine/jour) */
        .fc-timegrid-slot-label, /* √âtiquettes des heures (vue semaine/jour) */
        .fc-daygrid-day-frame a { /* Liens √† l'int√©rieur des jours */
            color: black !important;
            text-decoration: none !important;
        }

        /* --- SECTION RESPONSIVE (pour les √©crans plus petits comme les mobiles) --- */
        @media (max-width: 768px) {
            #calendar {
                padding: 10px; /* Moins d'espace int√©rieur sur mobile. */
            }

            /* La barre d'outils passe en mode colonne pour mieux s'adapter. */
            .fc-toolbar.fc-header-toolbar {
                flex-direction: column;
                align-items: center;
            }

            .fc-toolbar-chunk {
                margin-bottom: 8px; /* Espace entre les groupes de boutons. */
                text-align: center;
            }

            .fc-toolbar-title {
                font-size: 1.2rem; /* Titre plus petit sur mobile. */
            }

            .fc-button {
                font-size: 0.8rem; /* Boutons plus petits. */
                padding: 4px 8px;
            }

            .fc-daygrid-event {
                font-size: 0.75rem; /* Texte des √©v√©nements encore plus petit. */
                padding: 2px 4px;
            }

            /* R√©duit la taille des en-t√™tes de jours (Lundi, Mardi...) pour gagner de la place. */
            .fc-col-header-cell-cushion {
                font-size: 0.7em !important;
                padding: 2px 1px !important;
                line-height: 1.2; 
            }
            
            /* R√©duit l'espacement des cellules d'en-t√™te si elles sont encore trop serr√©es. */
            .fc-theme-standard .fc-scrollgrid th,
            .fc-theme-standard .fc-col-header-cell {
                padding-left: 1px !important;
                padding-right: 1px !important;
            }
        }
    </style>
{% endblock %}

{# --- SCRIPTS JAVASCRIPT SP√âCIFIQUES √Ä CETTE PAGE --- #}
{% block javascripts_page_specific %}
{# Lien vers la biblioth√®que JavaScript de FullCalendar via CDN. #}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>
    // Attend que le contenu HTML de la page (le DOM) soit enti√®rement charg√© avant d'ex√©cuter le script.
    // C'est une pratique essentielle pour √©viter les erreurs.
    document.addEventListener('DOMContentLoaded', function () {
        // S√©lectionne la 'div' avec l'id 'calendar' pour y injecter le calendrier.
        const calendarEl = document.getElementById('calendar');

        // --- GESTION RESPONSIVE EN JAVASCRIPT ---
        // ‚úÖ D√©tecte si la largeur de la fen√™tre est inf√©rieure √† 576px (consid√©r√© comme mobile).
        // Cette v√©rification est faite au chargement initial de la page.
        const isMobile = window.innerWidth < 576;

        // Cr√©e une nouvelle instance de FullCalendar.
        const calendar = new FullCalendar.Calendar(calendarEl, {
            // --- OPTIONS DE CONFIGURATION DE FULLCALENDAR ---

            initialView: 'dayGridMonth', // La vue par d√©faut est la vue "mois".
            locale: 'fr', // Affiche le calendrier en fran√ßais (noms des mois, jours...).
            firstDay: 1, // La semaine commence le Lundi (1) au lieu de Dimanche (0).

            // Affiche les jours en format court ("Lun.") sur mobile, et long ("Lundi") sur ordinateur.
            dayHeaderFormat: isMobile ? { weekday: 'short' } : { weekday: 'long' },

            // Indique √† FullCalendar o√π aller chercher les donn√©es des √©v√©nements.
            // Il fera une requ√™te AJAX √† l'URL g√©n√©r√©e par la route Symfony 'calendar_events'.
            // C'est la m√©thode la plus propre et la plus efficace pour charger des donn√©es dynamiques.
            events: "{{ path('calendar_events') }}",

            // Configure la barre d'outils en haut du calendrier.
            headerToolbar: {
                left: 'prev,next today', // √Ä gauche : boutons pr√©c√©dent, suivant, aujourd'hui.
                center: 'title', // Au centre : le titre (ex: "Juin 2024").
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth' // √Ä droite : les s√©lecteurs de vue.
            },

            // Traduit le texte des boutons.
            buttonText: {
                today:    'Aujourd\'hui',
                month:    'Mois',
                week:     'Semaine',
                day:      'Jour',
                list:     'Liste'
            },
            
            // Personnalise le texte des boutons pour chaque vue (assure la coh√©rence).
            views: {
                dayGridMonth: { buttonText: 'Mois' },
                timeGridWeek: { buttonText: 'Semaine' },
                timeGridDay: { buttonText: 'Jour' },
                listMonth:    { buttonText: 'Liste' }
            },

            // --- PERSONNALISATION DE L'AFFICHAGE DES √âV√âNEMENTS ---
            // Cette fonction permet de contr√¥ler le HTML √† l'int√©rieur de chaque √©v√©nement.
            eventContent: function(arg) {
                const timeText = arg.timeText; // L'heure de l'√©v√©nement (ex: "14:00").
                const title = arg.event.title; // Le titre de l'√©v√©nement.

                // Retourne un objet avec du code HTML personnalis√©.
                return {
                    html: `
                        <div class="fc-event-time" style="font-weight: bold;">${timeText}</div>
                        <div class="fc-event-title">${title}</div>
                    `
                };
            },

            // --- GESTION DES INFO-BULLES (TOOLTIPS) AU SURVOL ---
            // Cette fonction est appel√©e apr√®s qu'un √©v√©nement a √©t√© ajout√© au calendrier.
            eventDidMount: function(info) {
                // Cr√©e dynamiquement une 'div' qui servira d'info-bulle.
                const tooltip = document.createElement('div');
                // Applique des styles pour la rendre invisible et la positionner correctement.
                tooltip.classList.add('fc-event-tooltip');
                tooltip.style.position = 'absolute';
                tooltip.style.zIndex = '1000'; // S'affiche au-dessus de tout le reste.
                tooltip.style.background = 'rgba(0, 0, 0, 0.75)';
                tooltip.style.color = '#fff';
                tooltip.style.padding = '5px 10px';
                tooltip.style.borderRadius = '6px';
                tooltip.style.fontSize = '0.8rem';
                tooltip.style.display = 'none'; // Cach√©e par d√©faut.

                // Remplit l'info-bulle avec le titre et la description de l'√©v√©nement (si elle existe).
                // 'extendedProps' est l'endroit o√π vous pouvez mettre des donn√©es personnalis√©es depuis votre backend.
                tooltip.innerText = info.event.title + (info.event.extendedProps.description ? '\n' + info.event.extendedProps.description : '');
                
                // Ajoute l'info-bulle au 'body' de la page.
                document.body.appendChild(tooltip);

                // Ajoute un √©couteur d'√©v√©nement : quand la souris entre sur l'√©v√©nement...
                info.el.addEventListener('mouseenter', function(e) {
                    tooltip.style.display = 'block'; // ...on affiche l'info-bulle...
                    tooltip.style.left = e.pageX + 'px'; // ...√† la position du curseur.
                    tooltip.style.top = e.pageY + 'px';
                });

                // Quand la souris bouge sur l'√©v√©nement...
                info.el.addEventListener('mousemove', function(e) {
                    // ...on met √† jour la position de l'info-bulle pour qu'elle suive le curseur.
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });

                // Quand la souris quitte l'√©v√©nement...
                info.el.addEventListener('mouseleave', function () {
                    tooltip.style.display = 'none'; // ...on cache l'info-bulle.
                });
            }
        });

        // Affiche le calendrier sur la page. C'est l'appel final qui d√©clenche tout.
        calendar.render();

        // --- GESTION RESPONSIVE APR√àS LE CHARGEMENT ---
        // üîÅ Ajoute un √©couteur sur le redimensionnement de la fen√™tre.
        window.addEventListener('resize', function () {
            // Recalcule si on est en affichage mobile.
            const isMobileNow = window.innerWidth < 576;
            // Met √† jour dynamiquement l'option du calendrier pour le format des jours.
            // Le calendrier se redessinera automatiquement avec le bon format.
            calendar.setOption('dayHeaderFormat', isMobileNow ? { weekday: 'short' } : { weekday: 'long' });
        });
    });
</script>
{% endblock %}